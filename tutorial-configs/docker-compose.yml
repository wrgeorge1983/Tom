# Tom Smykowski Tutorial Setup
#
# This docker-compose brings up Tom configured to use an external Nautobot/NetBox
# as the source of truth.
#
# Services:
#   - controller: Tom API server
#   - worker: Tom workers (3 replicas)
#   - redis: Shared Redis for Tom queue/cache
#   - vault: HashiCorp Vault for credentials (dev mode)
#
# If you need a local NetBox for testing, uncomment the NetBox section below.

services:
  # =============================================================================
  # Tom Services
  # =============================================================================
  controller:
    image: ghcr.io/wrgeorge1983/tom-controller:latest
    environment:
      TOM_PROJECT_ROOT: /app
      TOM_CONFIG_FILE: /app/tom_controller_config.yaml
      TOM_REDIS_HOST: redis
      TOM_REDIS_PORT: 6379
    ports:
      - "8000:8000"
    volumes:
      - ./tom_controller_config.yaml:/app/tom_controller_config.yaml
      - ./templates:/app/templates
    depends_on:
      - redis

  worker:
    image: ghcr.io/wrgeorge1983/tom-worker:latest
    depends_on:
      - redis
      - vault
    deploy:
      replicas: 3
    environment:
      TOM_WORKER_PROJECT_ROOT: /app
      TOM_WORKER_REDIS_HOST: redis
      TOM_WORKER_REDIS_PORT: 6379
      TOM_WORKER_CREDENTIAL_PLUGIN: vault
      TOM_WORKER_PLUGIN_VAULT_URL: http://vault:8200
      TOM_WORKER_PLUGIN_VAULT_TOKEN: myroot

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  vault:
    image: hashicorp/vault:1.15
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: myroot
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: http://vault:8200
    cap_add:
      - IPC_LOCK
    command: ["vault", "server", "-dev"]

  # =============================================================================
  # NetBox Services (OPTIONAL - uncomment if you need a local NetBox)
  # =============================================================================
  # If using your own Nautobot/NetBox, leave these commented and update
  # tom_controller_config.yaml with your instance's URL and token.
  #
  # netbox:
  #   image: netboxcommunity/netbox:latest
  #   depends_on:
  #     - postgres
  #     - netbox-redis
  #   environment:
  #     # Database
  #     DB_HOST: postgres
  #     DB_NAME: netbox
  #     DB_USER: netbox
  #     DB_PASSWORD: netbox
  #     # Redis
  #     REDIS_HOST: netbox-redis
  #     REDIS_PORT: 6379
  #     REDIS_DATABASE: 0
  #     REDIS_CACHE_HOST: netbox-redis
  #     REDIS_CACHE_PORT: 6379
  #     REDIS_CACHE_DATABASE: 1
  #     # NetBox settings
  #     SECRET_KEY: "tutorial-secret-key-change-in-production-abc123def456"
  #     SUPERUSER_NAME: admin
  #     SUPERUSER_EMAIL: admin@example.com
  #     SUPERUSER_PASSWORD: admin
  #     SUPERUSER_API_TOKEN: "0123456789abcdef0123456789abcdef01234567"
  #     ALLOWED_HOSTS: "*"
  #     # Skip email config for tutorial
  #     EMAIL_FROM: netbox@example.com
  #     EMAIL_PASSWORD: ""
  #     EMAIL_PORT: 25
  #     EMAIL_SERVER: localhost
  #     EMAIL_SSL_CERTFILE: ""
  #     EMAIL_SSL_KEYFILE: ""
  #     EMAIL_TIMEOUT: 5
  #     EMAIL_USERNAME: netbox
  #     EMAIL_USE_SSL: "false"
  #     EMAIL_USE_TLS: "false"
  #     SKIP_SUPERUSER: "false"
  #   ports:
  #     - "8080:8080"
  #   volumes:
  #     - netbox-media:/opt/netbox/netbox/media
  #     - netbox-reports:/opt/netbox/netbox/reports
  #     - netbox-scripts:/opt/netbox/netbox/scripts
  #
  # netbox-worker:
  #   image: netboxcommunity/netbox:latest
  #   depends_on:
  #     - netbox
  #   environment:
  #     DB_HOST: postgres
  #     DB_NAME: netbox
  #     DB_USER: netbox
  #     DB_PASSWORD: netbox
  #     REDIS_HOST: netbox-redis
  #     REDIS_PORT: 6379
  #     REDIS_DATABASE: 0
  #     REDIS_CACHE_HOST: netbox-redis
  #     REDIS_CACHE_PORT: 6379
  #     REDIS_CACHE_DATABASE: 1
  #     SECRET_KEY: "tutorial-secret-key-change-in-production-abc123def456"
  #   command: /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
  #   volumes:
  #     - netbox-media:/opt/netbox/netbox/media
  #     - netbox-reports:/opt/netbox/netbox/reports
  #     - netbox-scripts:/opt/netbox/netbox/scripts
  #
  # netbox-housekeeping:
  #   image: netboxcommunity/netbox:latest
  #   depends_on:
  #     - netbox
  #   environment:
  #     DB_HOST: postgres
  #     DB_NAME: netbox
  #     DB_PASSWORD: netbox
  #     DB_USER: netbox
  #     REDIS_HOST: netbox-redis
  #     REDIS_PORT: 6379
  #     REDIS_DATABASE: 0
  #     REDIS_CACHE_HOST: netbox-redis
  #     REDIS_CACHE_PORT: 6379
  #     REDIS_CACHE_DATABASE: 1
  #     SECRET_KEY: "tutorial-secret-key-change-in-production-abc123def456"
  #   command: /opt/netbox/housekeeping.sh
  #   volumes:
  #     - netbox-media:/opt/netbox/netbox/media
  #     - netbox-reports:/opt/netbox/netbox/reports
  #     - netbox-scripts:/opt/netbox/netbox/scripts
  #
  # postgres:
  #   image: postgres:15-alpine
  #   environment:
  #     POSTGRES_DB: netbox
  #     POSTGRES_USER: netbox
  #     POSTGRES_PASSWORD: netbox
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #
  # netbox-redis:
  #   image: redis:7-alpine

# Uncomment these volumes if using the local NetBox services above
# volumes:
#   netbox-media:
#   netbox-reports:
#   netbox-scripts:
#   postgres-data:
