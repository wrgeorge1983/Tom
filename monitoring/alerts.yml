groups:
  - name: tom_alerts
    interval: 30s
    rules:
      # Worker health alerts
      - alert: WorkerDown
        expr: time() - tom_worker_last_heartbeat > 120
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Worker {{ $labels.worker }} is down"
          description: "Worker {{ $labels.worker }} hasn't sent a heartbeat in over 2 minutes"
      
      - alert: NoActiveWorkers
        expr: tom_workers_active == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No active workers"
          description: "There are no active workers available to process jobs"
      
      # Job failure alerts
      - alert: HighJobFailureRate
        expr: (sum(rate(tom_jobs_total{status="failed"}[5m])) / sum(rate(tom_jobs_total[5m]))) > 0.25
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High job failure rate"
          description: "Job failure rate is {{ $value | humanizePercentage }} over the last 5 minutes"
      
      - alert: DeviceHighFailureRate
        expr: (sum by (device) (rate(tom_jobs_total{status="failed"}[5m])) / sum by (device) (rate(tom_jobs_total[5m]))) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High failure rate for device {{ $labels.device }}"
          description: "Device {{ $labels.device }} has {{ $value | humanizePercentage }} failure rate"
      
      - alert: AuthenticationFailures
        expr: rate(tom_jobs_total{error_type="auth"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Authentication failures detected"
          description: "Authentication failures occurring at {{ $value }} per second"
      
      - alert: DeviceGatingIssues
        expr: rate(tom_jobs_total{error_type="gating"}[10m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Device contention issues"
          description: "High rate of device busy errors ({{ $value }} per second)"
      
      # Queue alerts
      - alert: HighQueueDepth
        expr: tom_queue_depth > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High queue depth"
          description: "Queue {{ $labels.queue }} has {{ $value }} jobs waiting"
      
      - alert: QueueStuck
        expr: tom_queue_depth > 50 and rate(tom_jobs_total[5m]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Queue appears stuck"
          description: "Queue {{ $labels.queue }} has {{ $value }} jobs but no processing activity"